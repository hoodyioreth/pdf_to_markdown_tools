# 📚 Project Overview: PDF → Markdown Converter (Modular)

This project converts PDFs into structured Markdown documents. It is designed to be modular, allowing flexible extraction and enrichment steps for various types of documents, including general academic files and Greyhawk-related campaign material (e.g., TOEE).

## 🎯 Purpose

- Convert PDFs into clean Markdown to reduce size and improve token efficiency
- Support flexible parsing logic across different PDF structures
- Enable Greyhawk enrichment by tagging places, factions, and locations using reference JSONs

## 🧱 Modular Script-Per-Task Architecture

Each module does one job. Example scripts include:

- `extract_text.py` – Raw text extraction (v1.4.0, input picker, progress bar)
- `extract_outline.py` – Built-in PDF TOC/bookmarks (v1.4.0, input picker)
- `parse_visual_toc.py` – Visual TOC scanning (v1.2.0, input picker)
- `detect_headings.py` – Heading detection (v1.0.1, font-size fallback)
- `convert_to_md.py` – Markdown output (planned)
- `split_sections.py` – Break long PDFs (planned)
- `tag_entities.py` – Optional Greyhawk tagging (planned)

## 🧰 Output Rules

- All scripts output to `../data/extracted_text/` from within `src/`
- Default mode shows progress bar (via `tqdm`)
- `--verbose` flag prints detailed logs instead

## ✅ Project Status

See `TODO.md` for live progress tracking.

---

Created with ChatGPT. Last updated 2025-05-31.


---

## 🔎 Phase 1 Detail – Core Markdown Pipeline Modules

These modules are the foundation of the PDF-to-Markdown conversion flow.

### 1. ✅ `convert_to_md.py`
**Purpose:** Convert cleaned `.txt` and metadata into well-structured `.md` files.

**Inputs:**
- Raw text: `../data/extracted_text/*.txt`
- Optional structure: `headings.json`, `toc.json`, `index.json`

**Outputs:**
- Markdown: `../data/extracted_text/*.md`

**Key Features:**
- Detect and format Markdown headers (`#`, `##`, etc.)
- Segment paragraphs intelligently
- Optionally inject `[MapRef: X]`, `[Ref: Y]` tags
- CLI: `--all`, `--help`, `--version`, `--verbose`

---

### 2. 🔄 `split_sections.py`
**Purpose:** Break large files into smaller Markdown segments.

**Inputs:**
- `.md` or `.txt` with headings
- May use `headings.json` or visual TOC for logic

**Outputs:**
- Segments like `myfile_part1.md`, `myfile_part2.md`

**Key Features:**
- Split by heading level (`--level 2`, etc.)
- Auto-create output folder
- Maintain order and reference continuity

---

### 3. 🧠 `extract_index.py`
**Purpose:** Parse index pages to extract structured term references.

**Inputs:**
- Raw PDF or text file
- Optional TOC or outline for cross-ref

**Outputs:**
- `index_terms.json` and/or `index_terms.md`

**Key Features:**
- Detect dot-leader index formats
- Capture term, page, and nearby topic
- Build foundation for tagging and glossaries

---

---

## 🧼 Phase 2 Detail – Markdown Cleanup & Structure Fixes

These tasks ensure that extracted content becomes readable, clean Markdown, free from parsing noise and format errors.

### 4. 🛠️ Fix malformed `headings.json` entries
**Purpose:** Clean corrupted or mixed-type heading arrays like `[1, 'X', 3]`.

**Inputs:**
- `headings.json` files (output from `detect_headings.py`)

**Outputs:**
- Cleaned `headings.json` with string-only entries

**Approach:**
- Strip non-string elements
- Detect garbage/duplicate lines
- Save corrected JSON alongside original (`headings_cleaned.json`)

---

### 5. 🧹 Clean bad structural tags (e.g., `[1, 'Contents', 3]`)
**Purpose:** Normalize Markdown output by converting structural debris into real headers.

**Inputs:**
- Markdown generated by `convert_to_md.py`
- Or directly from `headings.json` structure

**Outputs:**
- Updated `.md` files with valid headings (`## Contents`, etc.)

**Tactics:**
- Match malformed tags using regex
- Replace with standard heading markers (`#`, `##`)
- Flag ambiguous fragments for manual review (optional)

---

### 6. 🧠 Segment `.txt` into cleaner paragraphs
**Purpose:** Improve Markdown readability by detecting real paragraphs, not just line breaks.

**Inputs:**
- `.txt` files from `extract_text.py`

**Outputs:**
- More human-readable `.md` with paragraph breaks

**Implementation Ideas:**
- Use double line breaks as true paragraph breaks
- Collapse single-line breaks between dense text
- Maintain list, quote, and table integrity

---

These fixes dramatically improve the usability of Markdown for tools like Obsidian, VTTs, or GPT re-ingestion.

---

---

## 🟠 Phase 3 Detail – Post-Processing and Enhancements

These modules refine the Markdown output further for final consumption, ensuring clean layout, table usability, and formatting consistency.

### 7. 🧽 `clean_md_output.py`
**Purpose:** Post-process `.md` files to correct formatting, remove noise, and polish for human or VTT use.

**Inputs:**
- Raw `.md` files (from `convert_to_md.py` or earlier passes)

**Outputs:**
- Cleaned and normalized `.md` files

**Key Fixes:**
- Normalize spacing and line breaks
- Deduplicate repeated lines
- Adjust heading levels (`#`, `##`, `###`) consistently
- Remove empty list items or malformed bullets
- Optional flag: `--normalize-tables`, `--fix-headings`

---

### 8. 📊 Generate valid Markdown tables
**Purpose:** Detect structured blocks (lists, indented text, column layouts) and reformat them into Markdown tables.

**Inputs:**
- Raw `.txt` or `.md` files

**Outputs:**
- Tables rendered in pipe (`|`) and dash (`---`) syntax

**Implementation Suggestions:**
- Detect consistent spacing or delimiter patterns
- Use heuristics for common layouts (loot tables, stat blocks, etc.)
- Offer fallback to leave blocks unchanged if confidence is low

---

These post-processors elevate raw dumps into presentation-quality Markdown, ready for Obsidian, GitBook, or GPT use.

---

---

## 🟢 Phase 4 Detail – Optional Enrichment and Automation

These modules add polish, automation, or game-world enrichment. Not essential for baseline Markdown conversion but powerful for campaign use or productivity.

### 9. 🌍 `tag_entities.py`
**Purpose:** Enrich Markdown with `[Ref: ...]` and `[MapRef: ...]` tags using JSON keyword/entity data.

**Inputs:**
- `.md` files
- `ref_keywords.json`, `longitudes_from_map.json`

**Outputs:**
- Annotated `.md` with inline tags or footnotes

**Approach:**
- Match known entities by fuzzy or exact text search
- Tag entity types (e.g., [Ref: Iuz], [MapRef: Greyhawk])
- Optional: include lat/lon in `[MapRef: ...]` automatically

---

### 10. 🔗 `run_pipeline.py`
**Purpose:** Chain the full extraction pipeline for a given PDF using CLI.

**Functionality:**
- Call each core script in sequence: extract_text → headings → convert_to_md → clean
- Support flags like `--all`, `--debug`, `--skip-index`

**Benefits:**
- One-command PDF processing
- Useful for batch workflows and future GUI wrapping

---

### 11. ⚙️ `config.json`
**Purpose:** Allow per-document toggles or rules for the pipeline.

**Fields Could Include:**
- Custom TOC levels
- Exclusion lists
- Entity highlight overrides

**Future Use:**
- Supports flexible deployment for differing PDF formats

---

### 12. 🖱️ GUI Wrapper or Automator (macOS)
**Purpose:** Make tools accessible via point-and-click or script automation.

**Forms:**
- Simple Automator service on Mac
- Tkinter/HTML front-end CLI launcher

**Status:** Optional; wait for pipeline stability

---

### 13. 🧯 Error Handling and Logging Framework
**Purpose:** Capture failures in batch runs and produce clean logs.

**Key Ideas:**
- Use `try/except` blocks to catch per-file errors
- Write output logs (`runlog.json`, `errorlog.txt`)
- Add `--log` flag to scripts

---

---

## ✅ Phase 1 Completed: Markdown Conversion from Structured Text (`convert_to_md_v2.0.2.py`)

### Description
Markdown conversion from extracted `.txt` and `.outline.json` or `.headings.json` structure files was successfully tested across 7 key PDFs. Output files were written to `data/converted_md/`.

---

### 📄 PDFs Processed (by structure type)

**Structure: outline**
- Classic_Guide_to_Greyhawk
- Player's Guide to Greyhawk
- T0_The_Journey_to_Hommlet
- Greyhawk_Rebooted
- VER1-03_Gift_of_Beauty_(3E)
- World_of_Greyhawk_Gazetteer_Revised

**Structure: headings**
- Original_Adventures_Reincarnated_#6_-_The_Temple_of_Elemental_Evil-Part1-Pre5e ✅

---

### 🧪 Features Validated
- Auto-structure detection (`outline → headings → visual`)
- Markdown headings (`## Heading`) successfully injected
- Paragraph segmentation via double line breaks
- Output file routing to `converted_md/`
- CLI interactivity with fallback to `--all`

---

### ⚠️ Known Limitations
- No paragraph-to-heading alignment: content is flat after headings
- No heading depth logic (no `###`, `####` tiers)
- `[Ref: ...]` or `[MapRef: ...]` tags not yet injected (Phase 4)
- No YAML metadata frontmatter

---

### 🔄 Recommendation for Phase 2
Begin developing grouping logic to associate blocks of paragraphs with their correct heading — ideally with:
- Heading anchor detection or fuzzy matching
- Collapsing multiple paragraphs beneath one heading
- Tracking current section/subsection